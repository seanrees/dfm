#!/bin/sh
#
# Usage: install.sh [-isu]
#   -i: Install files.
#   -p: Run git pull first.
#   -s: Include "secure" files as well.
#   -u: Update files in git.
#

# Base paths to install. These are affected by args.
paths="data"
mode="install"
pull="false"

# Useful parameters for the rest of the script.
cwd=$(pwd -P)
base="$(dirname ${cwd}/${0})/.."
hostname=$(hostname)
whoami="${USER}@${hostname}"

# Arg parsing.
args=$(getopt ipsu $*)
if [ $? != 0 ]; then
    echo "Usage: $0 [-s]"
    exit 2
fi
set -- $args

for i
do
    case "$i"
    in
        -i)
            mode="install"
            shift;;
        -p)
            pull="true"
            shift;;
        -s)
            paths="${paths} secure"
            shift;;
        -u)
            mode="update"
            shift;;
        --)
            shift;
            break;;
    esac
done

# Real work.
if [ "x${mode}" = "xinstall" ]; then
    if [ "x${pull}" = "xtrue" ]; then
        git pull
    fi

    for path in ${paths}; do
        echo "Installing ${base}/${path}..."
        cp -Rpf ${base}/${path}/.* ${HOME}

        # In case there are non dot-files.
        if [ -f ${base}/${path}/* ]; then
            cp -Rpf ${base}/${path}/* ${HOME}
        fi
    done

    cat <<EOF > ${HOME}/bin/dfm
#!/bin/sh
#Generated by ${whoami} on $(date)
cd ${cwd}
${0} \$*
EOF
    chmod +x ${HOME}/bin/dfm
fi

if [ "x${mode}" = "xupdate" ]; then
    for path in ${paths}; do
        cd ${base}/${path}

        for i in $(find . -type f); do
            cp -Rpf ${HOME}/${i} ${base}/${path}/${i}
        done

        cd ${base}
        git add --all ${path}

        cd ${cwd}
    done

    cd ${base}
    git commit -m "${whoami} ran ${mode} with paths: ${paths}"
    git push origin master
fi
